<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calendar & Weather App</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Fira+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style-matrix2025-black.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- Bootstrap Icons for weather (legacy, can be removed if not used elsewhere) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.cdnfonts.com/css/digital-7-Mono" rel="stylesheet">
    <script>
      // Dashboard section refresh intervals (in ms)
      const REFRESH_EVENTS = 15 * 60 * 1000;   // 15 mins
      const REFRESH_BUSES = 5 * 60 * 1000;     // 5 mins
      const REFRESH_WEATHER = 15 * 60 * 1000;  // 15 mins
      const REFRESH_NEWS = 60 * 60 * 1000;     // 1 hour

      // Helper: fetch and update a section
      async function fetchAndUpdate(url, targetSelector, onSuccess) {
        try {
          const resp = await fetch(url, {cache: 'no-store', dataType: 'jsonp'});
          if (!resp.ok) return;
          const html = await resp.text();
          if (onSuccess) {
            onSuccess(html);
          } else {
            document.querySelector(targetSelector).innerHTML = html;
          }
        } catch (e) { /* ignore */ }
      }

      // Events refresh
      function refreshEvents() {
        fetchAndUpdate('/events-fragment', '.events-list');
        setTimeout(refreshEvents, REFRESH_EVENTS);
      }
      setTimeout(refreshEvents, REFRESH_EVENTS);

      // Bus times refresh
      function refreshBuses() {
        fetchAndUpdate('/buses-fragment', '.bus-times');
        setTimeout(refreshBuses, REFRESH_BUSES);
      }
      setTimeout(refreshBuses, REFRESH_BUSES);

      // Weather refresh
      function refreshWeather() {
        fetchAndUpdate('/weather-fragment', '.col.center:last-child');
        setTimeout(refreshWeather, REFRESH_WEATHER);
      }
      setTimeout(refreshWeather, REFRESH_WEATHER);

      // News refresh
      function refreshNews() {
        fetchAndUpdate('/news-fragment', '.news-ticker');
        setTimeout(refreshNews, REFRESH_NEWS);
      }
      setTimeout(refreshNews, REFRESH_NEWS);
    </script>
    <!-- Load external dashboard JS -->
    <script>
      window.newsEvents = {{ news_items|tojson|safe }};
    </script>
    <script src="/static/dashboard.js"></script>
</head>
<body>
<div class="container">
    <!-- Left column: Calendar events -->
    <div class="col">
        
        {% include 'fragments/events_fragment.html' %}
    </div>
    <!-- Middle column: Date and time -->
    <div class="col center">
        <div class="date-time">
            <div class="date-display">
                {{ now.strftime('%a, %b') }} {{ now.day }}, {{ now.year }}
            </div>
            <div id="clock" class="clock-display">
                {{ now.strftime('%H:%M') }}
            </div>
        </div>
        <!-- Wheelie Bin Collection Section -->
        <div class="bin-collection">
            <div class="bin-title">This week's bin collection ({{ bin_info.collection_day }}):</div>
            <div class="bin-list">
                {% for bin in bin_info.bins %}
                    <span class="bin-item" style="color: {{ bin.color }};">
                        <span class="bin-icon"><img src="{{ bin.icon }}" alt="{{ bin.name }} bin" style="height:1.5em;vertical-align:middle;"></span> {{ bin.name }}
                    </span>
                {% endfor %}
            </div>
        </div>
        {% if bus_departures %}
        {% set all_deps = [] %}
        {% for bus in bus_departures %}
            {% for dep in bus.departures[:2] %}
                {% set _ = all_deps.append({'service': bus.service, 'destination': dep.destination, 'time': dep.time}) %}
            {% endfor %}
        {% endfor %}
        {% set sorted_deps = all_deps|sort(attribute='time') %}
        <div class="bus-times">
            {% include 'fragments/buses_fragment.html' %}
        </div>
        {% else %}
            <div class="bus-times">No bus departures available.</div>
        {% endif %}
        {% if not bus_departures %}
            <div class="bus-times">No bus data available.</div>
        {% endif %}
        {% if not bin_info.bins %}
            <div class="bin-collection">No bin collection data available.</div>
        {% endif %}
    </div>
    
    <!-- Right column: Weather -->
    <div class="col center">
        {% include 'fragments/weather_fragment.html' %}
    </div>
    <!-- News ticker -->
    {% include 'fragments/news_fragment.html' %}
</div> <!-- end .container -->

    
</body>
</html>
