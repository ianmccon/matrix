<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calendar & Weather App</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Fira+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style-matrix2025-black.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- Bootstrap Icons for weather (legacy, can be removed if not used elsewhere) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.cdnfonts.com/css/digital-7-Mono" rel="stylesheet">
    <script>
      // Dashboard section refresh intervals (in ms)
      const REFRESH_EVENTS = 10 * 60 * 1000;   // 10 mins
      const REFRESH_BUSES = 5 * 60 * 1000;     // 5 mins
      const REFRESH_CURRENT_WEATHER = 60 * 60 * 1000;  // 1 hour
      const REFRESH_FORECAST = 3 * 60 * 60 * 1000;     // 3 hours
      const REFRESH_NEWS = 60 * 60 * 1000;     // 1 hour

      // Helper: fetch and update a section
      async function fetchAndUpdate(url, targetSelector, onSuccess) {
        try {
          const resp = await fetch(url, {cache: 'no-store', dataType: 'jsonp'});
          if (!resp.ok) return;
          const html = await resp.text();
          if (onSuccess) {
            onSuccess(html);
          } else {
            document.querySelector(targetSelector).innerHTML = html;
          }
        } catch (e) { /* ignore */ }
      }

      // Events refresh
      function refreshEvents() {
        fetchAndUpdate('/events-fragment', '.events-list');
        setTimeout(refreshEvents, REFRESH_EVENTS);
      }
      setTimeout(refreshEvents, REFRESH_EVENTS);

      // Bus times refresh
      function refreshBuses() {
        fetchAndUpdate('/buses-fragment', '.bus-times');
        setTimeout(refreshBuses, REFRESH_BUSES);
      }
      setTimeout(refreshBuses, REFRESH_BUSES);

      // Current weather refresh
      function refreshCurrentWeather() {
        fetchAndUpdate('/current-weather-fragment', '.current-weather');
        setTimeout(refreshCurrentWeather, REFRESH_CURRENT_WEATHER);
      }
      setTimeout(refreshCurrentWeather, REFRESH_CURRENT_WEATHER);

      // 5-day forecast refresh
      function refreshForecast() {
        fetchAndUpdate('/forecast-weather-fragment', '.weather-forecast');
        setTimeout(refreshForecast, REFRESH_FORECAST);
      }
      setTimeout(refreshForecast, REFRESH_FORECAST);

      // News refresh
      function refreshNews() {
        fetchAndUpdate('/news-fragment', '.news-ticker');
        setTimeout(refreshNews, REFRESH_NEWS);
      }
      setTimeout(refreshNews, REFRESH_NEWS);

      // Bin schedule refresh (every Thursday night at 23:59)
      function msUntilNextThursdayNight() {
        const now = new Date();
        const day = now.getDay(); // Sunday=0, Thursday=4
        const daysUntilThursday = (4 - day + 7) % 7;
        const nextThursday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + daysUntilThursday, 23, 59, 0, 0);
        if (nextThursday < now) nextThursday.setDate(nextThursday.getDate() + 7);
        return nextThursday - now;
      }
      function refreshBins() {
        fetchAndUpdate('/', '.bin-collection');
        setTimeout(refreshBins, 7 * 24 * 60 * 60 * 1000); // 1 week
      }
      setTimeout(refreshBins, msUntilNextThursdayNight());
    </script>
    <!-- Load external dashboard JS -->
    <script>
      window.newsEvents = {{ news_items|tojson|safe }};
    </script>
    <script src="/static/dashboard.js"></script>
    <style>
      .hide-cursor {
      cursor: none;
      }
    </style>
</head>
<body class="hide-cursor">
<div class="container">
    <!-- Left column: Calendar events -->
    <div class="col">
        
        {% include 'fragments/events-fragment.html' %}
    </div>
    <!-- Middle column: Date and time -->
    <div class="col center">
        <div class="date-time">
      <div class="date-display">
        <div id="date"></div>
      </div>
            <div id="clock" class="clock-display">
                {{ now.strftime('%H:%M') }}
            </div>
        </div>
        <!-- Wheelie Bin Collection Section -->
        <div class="bin-collection">
            <div class="bin-title">This week's bin collection ({{ bin_info.collection_day }}):</div>
            <div class="bin-list">
                {% for bin in bin_info.bins %}
                    <span class="bin-item" style="color: {{ bin.color }};">
                        <span class="bin-icon"><img src="{{ bin.icon }}" alt="{{ bin.name }} bin" style="height:1.5em;vertical-align:middle;"></span> {{ bin.name }}
                    </span>
                {% endfor %}
            </div>
        </div>
        {% if bus_departures %}
        {% set all_deps = [] %}
        {% for bus in bus_departures %}
            {% for dep in bus.departures[:2] %}
                {% set _ = all_deps.append({'service': bus.service, 'destination': dep.destination, 'time': dep.time}) %}
            {% endfor %}
        {% endfor %}
        {% set sorted_deps = all_deps|sort(attribute='time') %}
        <div class="bus-times">
            {% include 'fragments/buses-fragment.html' %}
        </div>
        {% else %}
            <div class="bus-times">No bus departures available.</div>
        {% endif %}
        {% if not bus_departures %}
            <div class="bus-times">No bus data available.</div>
        {% endif %}
        {% if not bin_info.bins %}
            <div class="bin-collection">No bin collection data available.</div>
        {% endif %}
    </div>
    
    <!-- Right column: Weather -->
    <div class="col center">
        {% include 'fragments/current-weather-fragment.html' %}
        {% include 'fragments/forecast-weather-fragment.html' %}
    </div>
    <!-- News ticker -->
    {% include 'fragments/news-fragment.html' %}
</div> <!-- end .container -->

    
</body>
</html>
